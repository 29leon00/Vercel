<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Jeu VR - Tire sur les canards ðŸ¦†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
</head>
<body style="margin: 0;">
  <a-scene vr-mode-ui="enabled: true">

    <!-- CamÃ©ra + curseur -->
    <a-entity id="cameraRig" camera look-controls position="0 1.6 0">
      <a-entity id="cursor"
                cursor="rayOrigin: entity" raycaster="objects: .clickable"
                position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                material="color: white; shader: flat">
      </a-entity>
    </a-entity>

    <!-- Fond panoramique -->
    <a-sky id="sky" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg"></a-sky>

    <!-- Score affichÃ© -->
    <a-text id="scoreText" value="Score: 0" position="-0.6 2 -1" color="white" width="3"></a-text>

    <!-- Canards -->
    <a-entity id="duck1" class="clickable duck"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/refs/heads/main/2.0/Duck/glTF/Duck.gltf"
      position="1 1 -3"
      scale="0.3 0.3 0.3"
      animation-mixer></a-entity>

    <a-entity id="duck2" class="clickable duck"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/refs/heads/main/2.0/Duck/glTF/Duck.gltf"
      position="-1 1 -2"
      scale="0.3 0.3 0.3"
      animation-mixer></a-entity>

    <a-entity id="duck3" class="clickable duck"
      gltf-model="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/refs/heads/main/2.0/Duck/glTF/Duck.gltf"
      position="0 1.2 -4"
      scale="0.3 0.3 0.3"
      animation-mixer></a-entity>

    <!-- Menu emojis arrondi -->


  </a-scene>

  <script>
    // Capteurs iOS
    window.addEventListener('click', function () {
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
          .then(response => {
            if (response === 'granted') console.log('Orientation activÃ©e');
            else alert('Permission capteur refusÃ©e');
          })
          .catch(console.error);
      }
    });

    // Avancer en cliquant dans le vide
    document.addEventListener("click", () => {
      const cursor = document.querySelector("#cursor");
      const intersections = cursor.components.raycaster.intersections;

      if (intersections.length > 0) {
        const target = intersections[0].object.el;
        if (target && target.classList.contains("clickable")) {
          target.emit("click");
          return;
        }
      }

      const cameraRig = document.querySelector("#cameraRig");
      const camera = cameraRig.components.camera.camera;
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);

      const currentPos = cameraRig.getAttribute("position");
      const step = 0.5;

      const newPos = {
        x: currentPos.x + direction.x * step,
        y: currentPos.y + direction.y * step,
        z: currentPos.z + direction.z * step,
      };

      cameraRig.setAttribute("position", newPos);
    });

    // Score et tirs
    let score = 0;

    function shootDuck(el) {
      el.parentNode.removeChild(el);
      score++;
      document.querySelector('#scoreText').setAttribute('value', `Score: ${score}`);
    }

    // DÃ©placement alÃ©atoire des canards
    function randomizeDuckPositions() {
      const ducks = document.querySelectorAll(".duck");
      ducks.forEach(duck => {
        const x = (Math.random() - 0.5) * 4;
        const y = 1 + Math.random() * 0.5;
        const z = -2 - Math.random() * 3;
        duck.setAttribute("position", `${x} ${y} ${z}`);
      });
    }

    // Initialisation
    document.addEventListener("DOMContentLoaded", () => {
      const ducks = document.querySelectorAll(".duck");
      ducks.forEach(duck => {
        duck.addEventListener("click", () => shootDuck(duck));
      });

      // Change position toutes les 2s
      setInterval(randomizeDuckPositions, 2000);

      // Menu emojis
      document.querySelector('#scene1').addEventListener('click', () => {
        document.querySelector('#sky').setAttribute('src', 'https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg');
      });
      document.querySelector('#scene2').addEventListener('click', () => {
        document.querySelector('#sky').setAttribute('src', 'https://cdn.aframe.io/360-video-boilerplate/video/city.mp4');
      });
    });
  </script>
</body>
</html>
