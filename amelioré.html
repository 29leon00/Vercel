<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>VR avec terrain g√©n√©r√©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
  <!-- Composant terrain -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-terrain-geometry-component@1.0.0/dist/aframe-terrain-geometry-component.min.js"></script>
</head>
<body style="margin: 0;">
  <a-scene vr-mode-ui="enabled: true">

    <!-- Cam√©ra + curseur -->
    <a-entity id="cameraRig" camera look-controls position="0 1.6 0" fov="80">
      <a-entity
        id="cursor"
        cursor="rayOrigin: entity"
        raycaster="objects: .clickable"
        position="0 0 -1"
        geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
        material="color: white; shader: flat"
      ></a-entity>
    </a-entity>

    <!-- Fond panoramique image (par d√©faut) -->
    <a-sky id="sky" src="https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg"></a-sky>

    <!-- Cube -->
    <a-box id="box" position="0 1.6 -3" color="#A0CED9"></a-box>

    <!-- Terrain 3D g√©n√©r√© (cach√© par d√©faut) -->
    <a-entity id="terrain" visible="false" terrain-geometry="heightmap: noise; radius: 50; scale: 10 4 10" material="color: #556B2F; wireframe: false" position="0 0 0"></a-entity>

    <!-- Menu emojis petit avec coins arrondis -->
    <a-entity id="menu" position="0 1.15 -1.2">
      <!-- Bouton 1 -->
      <a-circle
        id="scene1"
        class="clickable"
        radius="0.15"
        color="#ECECEC"
        position="-0.5 0 0"
        material="shader: flat"
        event-set__enter="_event: mouseenter; color: #DADADA"
        event-set__leave="_event: mouseleave; color: #ECECEC"
      >
        <a-text value="üåÖ" align="center" color="black" position="0 0 0.01" width="2"></a-text>
      </a-circle>

      <!-- Bouton 2 -->
      <a-circle
        id="scene2"
        class="clickable"
        radius="0.15"
        color="#ECECEC"
        position="0 0 0"
        material="shader: flat"
        event-set__enter="_event: mouseenter; color: #DADADA"
        event-set__leave="_event: mouseleave; color: #ECECEC"
      >
        <a-text value="üèûÔ∏è" align="center" color="black" position="0 0 0.01" width="2"></a-text>
      </a-circle>

      <!-- Bouton 3 -->
      <a-circle
        id="scene3"
        class="clickable"
        radius="0.15"
        color="#ECECEC"
        position="0.5 0 0"
        material="shader: flat"
        event-set__enter="_event: mouseenter; color: #DADADA"
        event-set__leave="_event: mouseleave; color: #ECECEC"
      >
        <a-text value="‚õ∞Ô∏è" align="center" color="black" position="0 0 0.01" width="2"></a-text>
      </a-circle>
    </a-entity>

  </a-scene>

  <script>
    // Activer capteurs iOS
    window.addEventListener("click", function () {
      if (
        typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function"
      ) {
        DeviceOrientationEvent.requestPermission()
          .then((response) => {
            if (response === "granted") console.log("Orientation activ√©e");
            else alert("Permission capteur refus√©e");
          })
          .catch(console.error);
      }
    });

    // Clic √©cran
    document.addEventListener("click", () => {
      const cursor = document.querySelector("#cursor");
      const intersections = cursor.components.raycaster.intersections;

      if (intersections.length > 0) {
        const target = intersections[0].object.el;
        if (target && target.classList.contains("clickable")) {
          target.emit("click");
          return;
        }
      }

      // Pas de bouton -> avancer cam√©ra dans la direction regard√©e
      const cameraRig = document.querySelector("#cameraRig");
      const camera = cameraRig.components.camera.camera;
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);

      const currentPos = cameraRig.getAttribute("position");
      const step = 0.5;

      const newPos = {
        x: currentPos.x + direction.x * step,
        y: currentPos.y + direction.y * step,
        z: currentPos.z + direction.z * step,
      };

      cameraRig.setAttribute("position", newPos);
    });

    // √âcoute clic menu
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelector("#scene1").addEventListener("click", () => changeScene(1));
      document.querySelector("#scene2").addEventListener("click", () => changeScene(2));
      document.querySelector("#scene3").addEventListener("click", () => changeScene(3));
    });

    // Changement de sc√®ne
    function changeScene(id) {
      const sky = document.querySelector("#sky");
      const box = document.querySelector("#box");
      const terrain = document.querySelector("#terrain");
      const cameraRig = document.querySelector("#cameraRig");

      if (id === 1) {
        sky.setAttribute("src", "https://cdn.aframe.io/360-image-gallery-boilerplate/img/sechelt.jpg");
        sky.setAttribute("visible", true);
        box.setAttribute("color", "#A0CED9");
        box.setAttribute("visible", true);
        terrain.setAttribute("visible", false);
        cameraRig.setAttribute("position", "0 1.6 0");
        cameraRig.setAttribute("camera", "fov: 80");
      } else if (id === 2) {
        sky.setAttribute("src", "https://raw.githubusercontent.com/aframevr/360-image-gallery/master/images/360.jpg");
        sky.setAttribute("visible", true);
        box.setAttribute("color", "#D65F5F");
        box.setAttribute("visible", true);
        terrain.setAttribute("visible", false);
        cameraRig.setAttribute("position", "0 1.6 0");
        cameraRig.setAttribute("camera", "fov: 80");
      } else if (id === 3) {
        sky.setAttribute("visible", false);
        box.setAttribute("visible", false);
        terrain.setAttribute("visible", true);
        cameraRig.setAttribute("position", "0 5 10");
        cameraRig.setAttribute("camera", "fov: 75");
      }
    }
  </script>
</body>
</html>
